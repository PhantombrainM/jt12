#!/bin/bash

TOP=jt12
DUMPSIGNALS=
DUMPSOUND=DONTDUMPSOUND
DUMPLFO=DONTDUMPLFO
LIMITTIME="LIMITTIME=100000"
EXTRA=
POSTPROC=NOTPOSTPROC
RANDWAIT=0
TIMERONLY=NOTTIMERONLY
TEST_NAME=NOTESTNAME
SSG_TEST=NOSSG_TEST
GYM_FILE=
GYM_ARG=
FAST=
#FAST=-DFASTDIV
# use SIMULATION="-DSIMULATION" to enable simulation statements
SIMULATION=

while [ $# -gt 0 ]; do
	if [ $1 = "-w" ]; then
		echo "Signal dump enabled"
		DUMPSIGNALS=--trace
		shift
		continue
	fi
	if [ $1 = "-sim" ]; then
		echo "Simulation signals enabled"
		SIMULATION=-DSIMULATION
		shift
		continue
	fi
	if [ $1 = "-gym" ]; then
		shift
		if [ ! -e $1 ]; then
			echo "Cannot open file " $1 " for GYM parsing"
			exit 1
		fi
		GYM_ARG="--gym"
		GYM_FILE="$1"
		shift
		continue
	fi
	if [ $1 = "-time" ]; then
		shift
		EXTRA=$EXTRA" --time "$1
		shift
		continue
	fi
	echo Unrecognized option
    exit 1
done

if [[ $(expr match "$GYM_FILE" ".*\.vgz") != 0 ]]; then
	echo Uncompressing vgz file...
	gunzip -S vgz "$GYM_FILE" --to-stdout > input.vgm
	GYM_FILE=input.vgm
fi

date

# rm -rf obj_dir
# export VERILATOR_ROOT=$(which verilator)

if ! verilator --cc -f gather.f --top-module $TOP -I../../hdl  \
	-DDISPLAY_STEP --trace -DTEST_SUPPORT \
    $SIMULATION -D$TIMERONLY -D$DUMPSOUND -D$LIMITTIME \
	-D$DUMPLFO -D$TEST_NAME -D$SSG_TEST \
	-D$POSTPROC -DICARUS $FAST --exe jt12_test.cpp VGMParser.cpp; then
	exit $?
fi

if ! make -j -C obj_dir -f Vjt12.mk Vjt12; then
	exit $?
fi
echo Simulation start...
echo obj_dir/Vjt12 $DUMPSIGNALS $EXTRA  $GYM_ARG "$GYM_FILE"
obj_dir/Vjt12 $DUMPSIGNALS $EXTRA $GYM_ARG "$GYM_FILE"